<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ğŸš€ AlphaGenesis ë°±í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-bg: #0a0e1a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 0 auto;
            max-width: 1400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .header h1 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .settings-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .settings-panel h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-display {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .status-ready {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .status-loading {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .results-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .results-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        
        .stat-value {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 700;
        }
        
        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .neutral { color: var(--warning-color); }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .chart-container h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .trades-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .trades-container h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            background: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            vertical-align: middle;
            color: #495057;
        }
        
        .progress-container {
            margin-top: 15px;
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px;
        }
        
        .error-display {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .results-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 18px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .param-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
        }
        
        .param-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .param-group input {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .param-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .data-period {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> AlphaGenesis ë°±í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
            <p>ë‹¤ì–‘í•œ ì „ëµìœ¼ë¡œ ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="settings-panel">
            <h3><i class="fas fa-cog"></i> ë°±í…ŒìŠ¤íŠ¸ ì„¤ì •</h3>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ì‹¬ë³¼</label>
                        <label class="form-label">ì‹¬ë³¼ <span class="badge bg-info">BTC/USDTë§Œ ì§€ì›</span></label>
                        <select id="symbolSelect" class="form-select" disabled>
                            <option value="BTC_USDT">BTC/USDT</option>
                        </select>
                        <div class="form-text text-danger">â€» í˜„ì¬ ë°±í…ŒìŠ¤íŠ¸ëŠ” BTC/USDTë§Œ ì§€ì›í•©ë‹ˆë‹¤.</div>
                        <!-- ë‚ ì§œ ì œí•œì€ JSì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì • -->
                        <!-- ë‚ ì§œ ì œí•œì€ JSì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì • -->
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ì „ëµ</label>
                        <select id="strategySelect" class="form-select" disabled>
                            <option value="CVD_0.01">CVD 0.01% ì „ëµ</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">ì´ˆê¸° ìë³¸</label>
                        <input type="number" id="initialCapital" class="form-control" value="10000000" min="1000" step="1000">
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-3">
                    <button id="downloadBtn" class="btn btn-primary w-100">
                        <i class="fas fa-download"></i> 1. ë°ì´í„° ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                <div class="col-md-3">
                    <button id="downloadStopBtn" class="btn btn-warning w-100" style="display:none;">
                        <i class="fas fa-stop"></i> ë‹¤ìš´ë¡œë“œ ì •ì§€
                    </button>
                </div>
                <div class="col-md-3">
                    <button id="backtestBtn" class="btn btn-success w-100" disabled>
                        <i class="fas fa-play"></i> 2. ë°±í…ŒìŠ¤íŠ¸ ì‹œì‘
                    </button>
                </div>
                <div class="col-md-3">
                    <button id="backtestStopBtn" class="btn btn-danger w-100" style="display:none;">
                        <i class="fas fa-stop"></i> ë°±í…ŒìŠ¤íŠ¸ ì •ì§€
                    </button>
                </div>
            </div>
            
            <div id="statusDisplay" class="status-display" style="display: none;"></div>
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-2" id="progressText">0%</small>
            </div>
        </div>

        <div id="errorDisplay" class="error-display" style="display: none;"></div>

        <div id="resultsContainer" class="results-container" style="display: none;">
            <h3><i class="fas fa-chart-bar"></i> ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">ì´ ìˆ˜ìµë¥ </span>
                    <span id="totalReturn" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ìŠ¹ë¥ </span>
                    <span id="winRate" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ìµœëŒ€ ë‚™í­ (MDD)</span>
                    <span id="maxDrawdown" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ìƒ¤í”„ ì§€ìˆ˜</span>
                    <span id="sharpeRatio" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì´ ê±°ë˜ íšŸìˆ˜</span>
                    <span id="totalTrades" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ìµœì¢… ìë³¸</span>
                    <span id="finalCapital" class="stat-value">-</span>
                </div>
            </div>
            
            <div class="chart-container">
                <h4><i class="fas fa-chart-area"></i> ìì‚° ê³¡ì„ </h4>
                <div id="equityChart" style="height: 400px;"></div>
            </div>
        </div>

        <div id="tradesContainer" class="trades-container" style="display: none;">
            <h4><i class="fas fa-list"></i> ë§¤ë§¤ ë¡œê·¸</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì‹œê°„</th>
                            <th>ì‹¬ë³¼</th>
                            <th>í–‰ë™</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ê°€ê²©</th>
                            <th>ê±°ë˜ê¸ˆì•¡</th>
                            <th>ìˆ˜ìˆ˜ë£Œ</th>
                            <th>ì†ìµ</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- ë§¤ë§¤ ë¡œê·¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let chart = null;
        let downloadedData = null;
        let dataStatus = 'idle'; // 'idle', 'downloading', 'ready', 'error'
        let backtestRunning = false;
        let downloadRunning = false;
        let dataMinDate = null;
        let dataMaxDate = null;
        
        // ì „ëµë³„ ê¸°ë³¸ íŒŒë¼ë¯¸í„°
        const strategyParams = {
            'SmaCross': [
                { name: 'pfast', label: 'ë‹¨ê¸° MA', default: 10, min: 1, max: 50 },
                { name: 'pslow', label: 'ì¥ê¸° MA', default: 30, min: 5, max: 200 }
            ],
            'RSI': [
                { name: 'period', label: 'ê¸°ê°„', default: 14, min: 5, max: 50 },
                { name: 'upper', label: 'ìƒë‹¨ì„ ', default: 70, min: 50, max: 90 },
                { name: 'lower', label: 'í•˜ë‹¨ì„ ', default: 30, min: 10, max: 50 }
            ],
            'BollingerBands': [
                { name: 'period', label: 'ê¸°ê°„', default: 20, min: 5, max: 50 },
                { name: 'devfactor', label: 'í‘œì¤€í¸ì°¨ ë°°ìˆ˜', default: 2, min: 1, max: 3 }
            ],
            'MACD': [
                { name: 'fast_period', label: 'ë¹ ë¥¸ ê¸°ê°„', default: 12, min: 5, max: 50 },
                { name: 'slow_period', label: 'ëŠë¦° ê¸°ê°„', default: 26, min: 10, max: 100 },
                { name: 'signal_period', label: 'ì‹œê·¸ë„ ê¸°ê°„', default: 9, min: 5, max: 30 }
            ],
            'TripleCombo': []
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadDataInfo();
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('strategySelect').addEventListener('change', updateParamInputs);
            document.getElementById('downloadBtn').addEventListener('click', downloadData);
            document.getElementById('downloadStopBtn').addEventListener('click', stopDownload);
            document.getElementById('backtestBtn').addEventListener('click', runBacktest);
            document.getElementById('backtestStopBtn').addEventListener('click', stopBacktest);

            // ì‹œì‘ì¼/ì¢…ë£Œì¼ ì…ë ¥ ì‹œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('startDate').addEventListener('input', checkDownloadReady);
            document.getElementById('endDate').addEventListener('input', checkDownloadReady);
            checkDownloadReady();
        });

        // ì‹œì‘ì¼/ì¢…ë£Œì¼ ì…ë ¥ ì‹œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
        function checkDownloadReady() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            document.getElementById('downloadBtn').disabled = !(start && end);
        }
        
        // ë‚ ì§œ ë²”ìœ„ ì„ íƒê¸° ì´ˆê¸°í™”
        function initializeDateRangePicker() {
            $('#dateRange').daterangepicker({
                startDate: moment().subtract(1, 'year'),
                endDate: moment(),
                locale: {
                    format: 'YYYY-MM-DD',
                    applyLabel: 'ì ìš©',
                    cancelLabel: 'ì·¨ì†Œ',
                    fromLabel: 'ë¶€í„°',
                    toLabel: 'ê¹Œì§€',
                    customRangeLabel: 'ì‚¬ìš©ì ì •ì˜',
                    daysOfWeek: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
                    monthNames: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”']
                }
            });
        }
        
        // ë°ì´í„° ì •ë³´ ë¡œë“œ
        function loadDataInfo() {
            fetch('/api/data/info')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    // ì‹¬ë³¼ ì˜µì…˜ ì—…ë°ì´íŠ¸
                    const symbolSelect = document.getElementById('symbolSelect');
                    symbolSelect.innerHTML = '';
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = symbol.replace('_', '/');
                        symbolSelect.appendChild(option);
                    });
                    // ë°ì´í„° ê¸°ê°„ ì •ë³´ í‘œì‹œ ë° ë‹¬ë ¥ ì œí•œ
                    if (data.start_date && data.end_date) {
                        dataMinDate = data.start_date;
                        dataMaxDate = data.end_date;
                        document.getElementById('startDate').setAttribute('min', dataMinDate);
                        document.getElementById('startDate').setAttribute('max', dataMaxDate);
                        document.getElementById('endDate').setAttribute('min', dataMinDate);
                        document.getElementById('endDate').setAttribute('max', dataMaxDate);
                        document.getElementById('startDate').value = dataMinDate;
                        document.getElementById('endDate').value = dataMaxDate;
                        const periodInfo = document.createElement('div');
                        periodInfo.className = 'data-period';
                        periodInfo.innerHTML = `<strong>ë°±í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ ê¸°ê°„:</strong> ${data.start_date} ~ ${data.end_date}`;
                        document.querySelector('.settings-panel').appendChild(periodInfo);
                    }
                })
                .catch(error => {
                    console.error('ë°ì´í„° ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                    showError('ë°ì´í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        // íŒŒë¼ë¯¸í„° ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        function updateParamInputs() {
            const strategy = document.getElementById('strategySelect').value;
            const container = document.getElementById('paramInputs');
            container.innerHTML = '';
            
            const params = strategyParams[strategy] || [];
            params.forEach(param => {
                const paramGroup = document.createElement('div');
                paramGroup.className = 'param-group';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `param_${param.name}`;
                input.value = param.default;
                input.min = param.min;
                input.max = param.max;
                
                paramGroup.appendChild(label);
                paramGroup.appendChild(input);
                container.appendChild(paramGroup);
            });
        }
        
        // ë°ì´í„° ë‹¤ìš´ë¡œë“œ
        // ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ì§„í–‰ë¥ /ì˜ˆìƒì‹œê°„ í‘œì‹œ)
        function downloadData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const symbol = 'BTC_USDT';
            if (!startDate || !endDate) {
                showError('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            setDataStatus('downloading');
            showProgress();
            downloadRunning = true;
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('downloadStopBtn').style.display = '';

            // ì§„í–‰ë¥  ì´ˆê¸°í™”
            updateProgress(0);
            let progress = 0;
            let estTime = 0;
            let progressInterval = null;
            const startTime = Date.now();

            // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ êµ¬í˜„ ì‹œ ì„œë²„ì—ì„œ ì§„í–‰ë¥  ë°›ì•„ì™€ì•¼ í•¨)
            progressInterval = setInterval(() => {
                if (!downloadRunning) {
                    clearInterval(progressInterval);
                    return;
                }
                progress += Math.random() * 10 + 5; // 5~15% ì¦ê°€
                if (progress > 100) progress = 100;
                estTime = Math.max(0, 5 - ((Date.now() - startTime) / 1000));
                updateProgress(progress);
                showStatus(`ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘... (${Math.round(progress)}%)  ì˜ˆìƒ ë‚¨ì€ ì‹œê°„: ${estTime.toFixed(1)}ì´ˆ`, 'loading');
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, 400);

            const params = new URLSearchParams({
                symbol: symbol,
                start_date: startDate,
                end_date: endDate
            });
            fetch(`/api/data/download?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (!downloadRunning) return;
                    if (data.error) {
                        setDataStatus('error');
                        showError(data.error);
                        return;
                    }
                    downloadedData = data;
                    setDataStatus('ready');
                    hideProgress();
                    document.getElementById('backtestBtn').disabled = false;
                    showStatus(`âœ… ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (${data.data_points}ê°œ ë°ì´í„° í¬ì¸íŠ¸)`, 'ready');
                })
                .catch(error => {
                    if (!downloadRunning) return;
                    console.error('ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    setDataStatus('error');
                    hideProgress();
                    showError('ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .finally(() => {
                    document.getElementById('downloadBtn').style.display = '';
                    document.getElementById('downloadStopBtn').style.display = 'none';
                    downloadRunning = false;
                });
        }

        function stopDownload() {
            downloadRunning = false;
            hideProgress();
            showStatus('ë°ì´í„° ë‹¤ìš´ë¡œë“œê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
            document.getElementById('downloadBtn').style.display = '';
            document.getElementById('downloadStopBtn').style.display = 'none';
        }
        
        // ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        function runBacktest() {
            if (dataStatus !== 'ready' || !downloadedData) {
                showError('ë¨¼ì € ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const symbol = 'BTC_USDT';
            const strategy = 'CVD_0.01';
            const initialCapital = parseFloat(document.getElementById('initialCapital').value);
            const config = {
                symbol: symbol,
                strategy: strategy,
                start_date: startDate,
                end_date: endDate,
                initial_capital: initialCapital,
                params: {}
            };
            backtestRunning = true;
            document.getElementById('backtestBtn').disabled = true;
            document.getElementById('backtestBtn').style.display = 'none';
            document.getElementById('backtestStopBtn').style.display = '';
            document.getElementById('downloadBtn').disabled = true;
            showProgress();
            showStatus('ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...', 'loading');
            simulateBacktest(config);
        }

        function stopBacktest() {
            backtestRunning = false;
            hideProgress();
            showStatus('ë°±í…ŒìŠ¤íŠ¸ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
            document.getElementById('backtestBtn').style.display = '';
            document.getElementById('backtestStopBtn').style.display = 'none';
            document.getElementById('backtestBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        }
        
        // ë°±í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì‹¤í–‰)
        function simulateBacktest(config) {
            const totalSteps = downloadedData.ohlcv.length;
            let currentStep = 0;
            let mockCapital = config.initial_capital;
            const equityCurve = [];
            
            function runStep() {
                if (currentStep >= totalSteps || !backtestRunning) {
                    // ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ
                    backtestRunning = false;
                    document.getElementById('backtestBtn').disabled = false;
                    document.getElementById('downloadBtn').disabled = false;
                    hideProgress();
                    showStatus('ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ!', 'ready');
                    return;
                }
                
                // ê°€ì§œ ìë³¸ ë³€ë™ (ì‹¤ì œë¡œëŠ” ì „ëµì— ë”°ë¼ ê³„ì‚°)
                const volatility = 0.01; // 1% ë³€ë™ì„±
                const change = (Math.random() - 0.5) * volatility;
                mockCapital *= (1 + change);
                
                const currentDataPoint = downloadedData.ohlcv[currentStep];
                equityCurve.push({
                    time: currentDataPoint.time,
                    value: mockCapital
                });
                
                // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
                const progress = (currentStep / totalSteps) * 100;
                updateProgress(progress);
                
                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (100ê°œ í¬ì¸íŠ¸ë§ˆë‹¤)
                if (currentStep % Math.max(1, Math.floor(totalSteps / 100)) === 0) {
                    updateEquityChart(equityCurve);
                    updateResults({
                        total_return: ((mockCapital - config.initial_capital) / config.initial_capital * 100).toFixed(2),
                        win_rate: (Math.random() * 30 + 50).toFixed(2),
                        max_drawdown: (Math.random() * 10 + 5).toFixed(2),
                        sharpe_ratio: (Math.random() * 1.5).toFixed(2),
                        total_trades: Math.floor(currentStep / 10),
                        final_capital: mockCapital.toFixed(2)
                    });
                }
                
                currentStep++;
                setTimeout(runStep, 10); // 10ms ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
            }
            
            runStep();
        }
        
        // ìì‚° ê³¡ì„  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateEquityChart(data) {
            if (!chart) {
                const chartContainer = document.getElementById('equityChart');
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        textColor: '#333',
                        background: { type: 'solid', color: '#ffffff' }
                    },
                    grid: {
                        vertLines: { color: '#f0f0f0' },
                        horzLines: { color: '#f0f0f0' }
                    },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false
                    }
                });
                
                const areaSeries = chart.addAreaSeries({
                    topColor: 'rgba(102, 126, 234, 0.56)',
                    bottomColor: 'rgba(102, 126, 234, 0.04)',
                    lineColor: 'rgba(102, 126, 234, 1)',
                    lineWidth: 2
                });
                
                chart.areaSeries = areaSeries;
            }
            
            if (data.length > 0) {
                chart.areaSeries.setData(data);
                chart.timeScale().fitContent();
            }
        }
        
        // ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateResults(results) {
            document.getElementById('totalReturn').textContent = results.total_return + '%';
            document.getElementById('winRate').textContent = results.win_rate + '%';
            document.getElementById('maxDrawdown').textContent = results.max_drawdown + '%';
            document.getElementById('sharpeRatio').textContent = results.sharpe_ratio;
            document.getElementById('totalTrades').textContent = results.total_trades;
            document.getElementById('finalCapital').textContent = '$' + parseFloat(results.final_capital).toLocaleString();
            
            // ìƒ‰ìƒ ì ìš©
            document.getElementById('totalReturn').className = 'stat-value ' + (parseFloat(results.total_return) >= 0 ? 'positive' : 'negative');
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            document.getElementById('resultsContainer').style.display = 'block';
        }
        
        // ë§¤ë§¤ ë¡œê·¸ ì—…ë°ì´íŠ¸ (ë”ë¯¸ ë°ì´í„°)
        function updateTradeLogs() {
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';
            
            // ë”ë¯¸ ë§¤ë§¤ ë¡œê·¸ ìƒì„±
            const mockTrades = [
                { date: '2023-01-15', time: '10:30:00', symbol: 'BTC/USDT', action: 'BUY', size: 0.1, price: '30000.00', value: '3000.00', commission: '3.00', pnl: '' },
                { date: '2023-01-20', time: '14:45:00', symbol: 'BTC/USDT', action: 'SELL', size: 0.1, price: '31000.00', value: '3100.00', commission: '3.10', pnl: '+100.00' },
                { date: '2023-02-01', time: '09:15:00', symbol: 'BTC/USDT', action: 'BUY', size: 0.15, price: '30500.00', value: '4575.00', commission: '4.58', pnl: '' },
                { date: '2023-02-10', time: '16:20:00', symbol: 'BTC/USDT', action: 'SELL', size: 0.15, price: '32000.00', value: '4800.00', commission: '4.80', pnl: '+225.00' }
            ];
            
            mockTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.time}</td>
                    <td>${trade.symbol}</td>
                    <td><span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.action}</span></td>
                    <td>${trade.size}</td>
                    <td>$${trade.price}</td>
                    <td>$${trade.value}</td>
                    <td>$${trade.commission}</td>
                    <td class="${trade.pnl ? (parseFloat(trade.pnl) >= 0 ? 'text-success' : 'text-danger') : ''}">${trade.pnl || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('tradesContainer').style.display = 'block';
        }
        
        // ìƒíƒœ í‘œì‹œ
        function setDataStatus(status) {
            dataStatus = status;
        }
        
        function showStatus(message, type) {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.textContent = message;
            statusDisplay.className = `status-display status-${type}`;
            statusDisplay.style.display = 'block';
        }
        
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = Math.round(percent) + '%';
        }
        
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 5000);
        }
        
        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
        window.addEventListener('resize', function() {
            if (chart) {
                chart.applyOptions({ width: document.getElementById('equityChart').clientWidth });
            }
        });
    </script>
</body>
        <script>
        // ì‹¤ì œ ë°ì´í„° ë²”ìœ„ì— ë§ê²Œ ë‚ ì§œ ì„ íƒ ì œí•œ
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/data/info')
                .then(res => res.json())
                .then(data => {
                    if (data && data.start_date && data.end_date) {
                        document.getElementById('startDate').setAttribute('min', data.start_date);
                        document.getElementById('startDate').setAttribute('max', data.end_date);
                        document.getElementById('endDate').setAttribute('min', data.start_date);
                        document.getElementById('endDate').setAttribute('max', data.end_date);
                        // ê¸°ë³¸ê°’ë„ ë°ì´í„° ë²”ìœ„ ë‚´ë¡œ
                        document.getElementById('startDate').value = data.start_date;
                        document.getElementById('endDate').value = data.end_date;
                    }
                });
        });
        </script>
</html>

